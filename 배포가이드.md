# 🚀 BakeCalc 완전 배포 및 실행 가이드

## 📋 개요
BakeCalc는 제과제빵 영양성분 계산, 원가 분석, QR 공유 기능을 제공하는 Django 웹앱입니다.

## ✨ 새로 추가된 주요 기능

### 💰 원가 계산 시스템
- 재료별 100g당 가격 입력
- 손실률 적용 실제 원가 계산
- 마진율 기반 권장 판매가 제안
- Admin 패널에서 원가 팝업으로 즉시 확인

### 📱 QR 공유 시스템
- 레시피별 고유 공개 ID 자동 생성
- 모바일 최적화 공개 라벨 페이지
- `/p/{public_id}` 형태의 공유 URL
- QR 코드로 고객이 직접 영양정보 확인

### 🎨 Admin UI 개선
- 4개 액션 버튼: 🏷️라벨, 📄PDF, 💰원가, 📱QR
- 중앙 정렬된 깔끔한 테이블 디자인
- 원가 정보 모달 팝업
- 반응형 버튼 레이아웃

---

## 🔧 로컬 개발 환경 설정

### 1. 프로젝트 클론 및 가상환경 설정
```bash
# GitHub에서 클론
git clone https://github.com/vnme1/BakeCalc.git
cd BakeCalc

# 가상환경 생성 및 활성화
python -m venv .venv

# Windows
.\.venv\Scripts\Activate.ps1
# macOS/Linux
source .venv/bin/activate
```

### 2. 의존성 설치
```bash
pip install -r requirements.txt
```

### 3. 환경변수 설정
```bash
# .env 파일 생성 (Windows)
copy .env.example .env

# .env 파일 생성 (macOS/Linux)
cp .env.example .env
```

`.env` 파일 내용 수정:
```
DJANGO_DEBUG=True
DJANGO_SECRET_KEY=your-secret-key-here
ALLOWED_HOSTS=127.0.0.1,localhost
# DATABASE_URL=postgres://user:pass@localhost:5432/bakecalc  # PostgreSQL 사용시
```

### 4. 데이터베이스 마이그레이션
```bash
# 마이그레이션 파일 생성
python manage.py makemigrations

# 마이그레이션 실행
python manage.py migrate

# 관리자 계정 생성
python manage.py createsuperuser
```

### 5. 개발 서버 실행
```bash
python manage.py runserver
```

접속: http://127.0.0.1:8000/
Admin: http://127.0.0.1:8000/admin/

---

## 📦 배포 환경 설정

### PostgreSQL 사용 (권장)
```bash
# PostgreSQL 설치 후
pip install psycopg2-binary

# .env 파일에 DATABASE_URL 설정
DATABASE_URL=postgres://username:password@localhost:5432/bakecalc
```

### 정적 파일 설정
```bash
# 정적 파일 수집
python manage.py collectstatic

# Nginx 설정 예시
server {
    listen 80;
    server_name yourdomain.com;
    
    location /static/ {
        alias /path/to/BakeCalc/static/;
    }
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

---

## 🛠 새 기능 사용법

### 💰 원가 계산 사용법

1. **재료 가격 입력**
   - Admin > 재료 목록
   - 각 재료의 "가격(100g당)" 필드에 구매 단가 입력
   - 예: 밀가루 500원, 설탕 300원

2. **레시피 원가 확인**
   - Admin > 레시피 목록
   - "💰 원가" 버튼 클릭
   - 마진율 입력 (예: 150 = 50% 마진)
   - 팝업에서 원가 분석 결과 확인

3. **원가 계산 로직**
   ```
   총 원재료비 = Σ(사용량g ÷ 100 × 재료단가)
   손실률 적용 원가 = 총 원재료비 ÷ (수율% ÷ 100)
   조각당 원가 = 손실률 적용 원가 ÷ 제공 횟수
   권장 판매가 = 조각당 원가 × (마진율% ÷ 100)
   ```

### 📱 QR 공유 사용법

1. **공개 ID 생성**
   - 레시피 저장시 8자리 랜덤 ID 자동 생성
   - 예: `abc123de`

2. **공유 페이지 접근**
   - Admin > 레시피 목록 > "📱 QR" 버튼 클릭
   - 공개 URL: `https://yourdomain.com/p/abc123de`

3. **QR 코드 생성**
   - 공개 URL을 QR 생성기에 입력
   - 매장 테이블이나 포장지에 QR 코드 부착
   - 고객이 스캔하여 영양정보 확인

4. **모바일 최적화**
   - 반응형 디자인으로 모든 기기 대응
   - 아름다운 그라데이션 UI
   - 빠른 로딩 속도

---

## 🔗 새로운 API 엔드포인트

### 원가 계산 API
```http
GET /api/recipes/{id}/cost?margin=150
```

**요청 예시:**
```bash
curl "http://localhost:8000/api/recipes/1/cost?margin=150"
```

**응답 예시:**
```json
{
  "recipe_id": 1,
  "title": "초콜릿 브라우니",
  "cost_analysis": {
    "total_cost": 1500.00,
    "adjusted_total_cost": 1630.43,
    "cost_per_piece": 203.80,
    "suggested_price_per_piece": 305.70,
    "suggested_total_price": 2445.60,
    "margin_percent": 150,
    "yield_rate": 92,
    "servings": 8,
    "items_cost": [
      {
        "ingredient": "밀가루",
        "amount_g": 200,
        "price_per_100g": 500,
        "cost": 1000
      }
    ]
  }
}
```

### QR 공유 API
```http
POST /api/recipes/{id}/share/
```

**응답 예시:**
```json
{
  "recipe_id": 1,
  "title": "초콜릿 브라우니",
  "public_id": "abc123de",
  "share_url": "http://localhost:8000/p/abc123de"
}
```

### 공개 라벨 페이지
```http
GET /p/{public_id}
```

---

## 📊 데이터 구조

### 새로 추가된 필드

**Ingredient 모델:**
```python
price_per_100g = DecimalField(max_digits=10, decimal_places=2, default=0)
# 100g 기준 구매 단가 (원)
```

**Recipe 모델:**
```python
public_id = CharField(max_length=16, unique=True, blank=True)
# QR 공유용 고유 ID (자동 생성)
```

---

## 🎯 사용 시나리오

### 제과점 사장님 사용법

1. **재료 등록**
   ```
   - 밀가루 (500원/100g)
   - 설탕 (300원/100g)  
   - 버터 (2000원/100g)
   - 계란 (유제품, 계란 알레르기 체크)
   ```

2. **레시피 등록**
   ```
   - 초콜릿 케이크 (8조각, 수율 92%)
   - 밀가루 200g, 설탕 150g, 버터 100g
   ```

3. **원가 분석**
   ```
   원재료비: 1,250원
   손실률 적용: 1,359원
   조각당 원가: 170원
   권장 판매가: 255원 (50% 마진)
   ```

4. **QR 공유**
   ```
   - QR 코드를 케이크 포장지에 부착
   - 고객이 스캔하여 칼로리, 알레르기 정보 확인
   - 투명한 영양정보 제공으로 신뢰도 향상
   ```

---

## 🚨 문제 해결

### 마이그레이션 오류
```bash
# 마이그레이션 충돌 해결
python manage.py migrate --fake-initial
python manage.py showmigrations
python manage.py migrate
```

### 정적 파일 문제
```bash
# 정적 파일 캐시 클리어
python manage.py collectstatic --clear --noinput
```

### 한글 PDF 폰트 오류
Windows에서 PDF 생성시 한글이 깨질 경우:
```python
# nutrition/services/pdf.py 수정
# 시스템에 맞는 한글 폰트 경로 설정
font_paths = [
    r'C:\Windows\Fonts\malgun.ttf',    # 맑은고딕
    r'C:\Windows\Fonts\gulim.ttc',     # 굴림
    '/System/Library/Fonts/AppleGothic.ttf',  # macOS
]
```

### 원가 계산 0원 문제
1. 재료의 `price_per_100g` 값이 입력되었는지 확인
2. `amount_ml` 사용시 재료의 `density_g_per_ml` 설정 확인
3. 레시피 아이템이 정상적으로 연결되었는지 확인

---

## 🔒 보안 고려사항

### 공개 라벨 보안
- `public_id`는 8자리 랜덤 문자열로 추측 어려움
- 민감한 원가 정보는 Admin 로그인 필요
- 공개 페이지는 영양정보만 노출

### 배포시 보안 설정
```python
# settings.py (배포시)
DEBUG = False
ALLOWED_HOSTS = ['yourdomain.com']
SECURE_SSL_REDIRECT = True
SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
```

---

## 🚀 성능 최적화

### 데이터베이스 최적화
```python
# 쿼리 최적화 (이미 적용됨)
recipe = get_object_or_404(
    Recipe.objects.prefetch_related('items__ingredient'), 
    pk=recipe_id
)
```

### 캐싱 설정 (권장)
```python
# settings.py
CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/1',
    }
}

# 공개 라벨 캐싱
from django.views.decorators.cache import cache_page

@cache_page(60 * 15)  # 15분 캐싱
def recipe_public(request, public_id):
    # ...
```

---

## 📈 향후 개발 계획

### 단기 (2-4주)
- [ ] QR 코드 자동 생성 및 다운로드
- [ ] 재료 CSV 일괄 업로드
- [ ] 라벨 템플릿 커스터마이징 (3-5종)
- [ ] 원가 분석 차트 및 그래프

### 중기 (1-2개월)
- [ ] 팀 계정 및 권한 관리
- [ ] 사용량 통계 및 분석 대시보드
- [ ] 구독 결제 시스템 (토스페이먼츠)
- [ ] 모바일 앱 개발

### 장기 (3-6개월)
- [ ] 공공 식품 DB 연동 (자동완성)
- [ ] AI 기반 레시피 추천
- [ ] 재고 관리 시스템
- [ ] 프랜차이즈 관리 기능

---

## 🆘 지원 및 문의

- **GitHub Issues**: https://github.com/vnme1/BakeCalc/issues
- **문서**: 이 가이드 참조
- **이메일**: (개발자 이메일 주소)

---

## 📝 라이선스
MIT License - 자유롭게 사용, 수정, 배포 가능

---

**🎉 축하합니다! BakeCalc가 성공적으로 설치되었습니다.**  
이제 제과점의 영양성분 관리와 원가 분석을 효율적으로 수행할 수 있습니다!